name: üöÄ Auto Deploy & Smile

on:
  push:
    branches: 
    - "main"

jobs:
  distant_deploy:
    runs-on: ubuntu-latest

    steps:
      # üîê 1. Chargement de la cl√© SSH
      - name: üîê Charger la cl√© SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.RPI_SSH_KEY }}

      # üß™ 2. Mise √† jour du git
      - name: üß™ Mise √† jour du git (git pull)
        env:
          SSH_HOST: ${{ secrets.RPI_IP }}
          SSH_USER: ${{ secrets.RPI_USER }}
          SSH_PORT: ${{ secrets.RPI_SSH_PORT }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$PORT" "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" << EOF
            cd /home/pi/CheckFesseDomain || exit 1
            git pull origin main
          EOF

      # üöÄ 3. D√©ploiement Docker
      - name: üöÄ Deploy & Docker Compose
        env:
          SSH_HOST: ${{ secrets.RPI_IP }}
          SSH_USER: ${{ secrets.RPI_USER }}
          SSH_PORT: ${{ secrets.RPI_SSH_PORT }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$PORT" "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" << EOF
            cd /home/pi/CheckFesseDomain || exit 1

            docker stop domain-watcher || true
            docker rm domain-watcher || true
            docker rmi domain-watcher:latest || true

            docker build -t domain-watcher .

            echo "‚úÖ D√âMARRAGE AVEC : DOMAIN_NAME=\$DOMAIN_NAME"

            docker run -d \
              --name domain-watcher \
              --restart unless-stopped \
              -e DOMAIN_NAME="${DOMAIN_NAME}" \
              -e TELEGRAM_TOKEN="${TELEGRAM_TOKEN}" \
              -e TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID}" \
              domain-watcher
          EOF

      # üöÄ 4. Annonce sur discord
      - name: üì¢ Discord finish deployment announcement
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        args: >-
          {
            "embeds": [
              {
                "title": "Github",
                "description": "‚úÖ D√©ploiement **termin√©**.\n\n",
                "color": 3992355,
                "author": {
                  "name": "Nouveau COMMIT"
                },
                "url": "https://github.com/{{ EVENT_PAYLOAD.repository.full_name }}",
                "footer": {
                  "text": "G√©n√©r√© automatiquement via notre script de deploiement"
                }
              }
            ]
          }

  ping_discord:
    runs-on: ubuntu-latest
    steps:
      - name: üì° Discord pre notification
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        uses: Ilshidur/action-discord@master
        with:
        args: >-
          {
            "embeds": [
              {
                "title": "Github",
                "description": "‚è∞ [{{EVENT_PAYLOAD.head_commit.timestamp}}] - D√©ploiement en cours.\n\nüîß {{EVENT_PAYLOAD.head_commit.message}}",
                "color": 15410096,
                "author": {
                  "name": "Nouveau COMMIT"
                },
                "url": "https://github.com/{{ EVENT_PAYLOAD.repository.full_name }}",
                "footer": {
                  "text": "G√©n√©r√© automatiquement via notre script de deploiement"
                }
              }
            ]
          }
