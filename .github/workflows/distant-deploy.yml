name: ðŸš€ Auto Deploy & Smile

on:
  push:
    branches: 
    - "main"

jobs:
  distant_deploy:
    runs-on: ubuntu-latest

    steps:
      # ðŸ” 1. Chargement de la clÃ© SSH
      - name: ðŸ” Charger la clÃ© SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.RPI_SSH_KEY }}

      # ðŸ§ª 2. Mise Ã  jour du git
      - name: ðŸ§ª Mise Ã  jour du git (git pull)
        env:
          SSH_HOST: ${{ secrets.RPI_IP }}
          SSH_USER: ${{ secrets.RPI_USER }}
          SSH_PORT: ${{ secrets.RPI_SSH_PORT }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$PORT" "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" << EOF
            cd /home/pi/CheckFesseDomain || exit 1
            git pull origin main
          EOF

      # ðŸš€ 3. DÃ©ploiement Docker
      - name: ðŸš€ Deploy & Docker Compose
        env:
          SSH_HOST: ${{ secrets.RPI_IP }}
          SSH_USER: ${{ secrets.RPI_USER }}
          SSH_PORT: ${{ secrets.RPI_SSH_PORT }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          PORT="${SSH_PORT:-22}"
          ssh-keyscan -p "$PORT" "$SSH_HOST" >> ~/.ssh/known_hosts

          ssh -p "$PORT" "$SSH_USER@$SSH_HOST" << EOF
            cd /home/pi/CheckFesseDomain || exit 1

            docker stop domain-watcher || true
            docker rm domain-watcher || true
            docker rmi domain-watcher:latest || true

            docker build -t domain-watcher .

            echo "âœ… DÃ‰MARRAGE AVEC : DOMAIN_NAME=\$DOMAIN_NAME"

            docker run -d \
              --name domain-watcher \
              --restart unless-stopped \
              -e DOMAIN_NAME="${DOMAIN_NAME}" \
              -e TELEGRAM_TOKEN="${TELEGRAM_TOKEN}" \
              -e TELEGRAM_CHAT_ID="${TELEGRAM_CHAT_ID}" \
              domain-watcher
          EOF

      # ðŸš€ 4. Annonce sur discord
      - name: ðŸ“¢ Discord finish deployment announcement
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "Github",
                "description": "âœ… DÃ©ploiement **terminÃ©**.\n\n",
                "color": 3992355,
                "author": {
                  "name": "Nouveau COMMIT"
                },
                "url": "https://github.com/${{ github.repository }}",
                "footer": {
                  "text": "GÃ©nÃ©rÃ© automatiquement via notre script de deploiement"
                }
              }
            ]
          }'

  ping_discord:
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¡ Discord pre notification with embed
        env:
            DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          curl -X POST ${{ secrets.DISCORD_WEBHOOK }} \
          -H "Content-Type: application/json" \
          -d '{
            "embeds": [
              {
                "title": "Github",
                "description": "â° [${{ github.event.head_commit.timestamp }}] - DÃ©ploiement en cours.\n\nðŸ”§ ${{ github.event.head_commit.message }}",
                "color": 15410096,
                "author": {
                  "name": "Nouveau COMMIT"
                },
                "url": "https://github.com/${{ github.repository }}",
                "footer": {
                  "text": "GÃ©nÃ©rÃ© automatiquement via notre script de deploiement"
                }
              }
            ]
          }'
